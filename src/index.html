<!DOCTYPE html>
<html lang="en">
  <head>

    <!-- Page Basics
    ================================================== -->
    <meta charset="utf-8">
    <title></title>
    <meta name="description" content="">
    <meta name="author" content="Jason Davis">

    <!-- Mobile Metas
    ================================================== -->
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

    <!-- CSS
    ================================================== -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/3.0.2/normalize.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/skeleton/2.0.4/skeleton.css">
    <link rel="stylesheet" href="css/webdevtest.css">

    <!-- IE HTML5 SHIM
    ================================================== -->
    <!--[if lt IE 9]>
    <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

    <base href="/">

    <!-- No Favicons -->

  </head>
  <body ng-app="mockApp">

    <div class="container" ng-controller="listCtrl">
      <!-- repeat over the promos in promotion objects if the querystring is empty -->
      <div ng-hide="query" class="row" ng-repeat="promo in promoData.promotion_objects">
        <div class="twelve columns">
          <div class="promo-img">
            <img ng-src="{{promo.promo_image_url}}" alt="" />
          </div>
          <div class="promo-data">
            <div class="promo-link">
              <a ng-href="/?promo=promo0{{$index+1}}" ng-click="setQuery($index)">{{promo.promotion_name}}</a>
            </div>
            <div class="promo-summary">
              <p>
                {{promo.summary}}
              </p>
              <p>
                Next Drawing Date: {{promo.nextDate}}
              </p>
            </div>
          </div>
        </div>
      </div>


      <!-- if there is a querystring show the resulting promo -->
      <div ng-hide="!query">
        <div class="row">
          <div class="twelve columns">
            <img ng-src="{{selectedPromo.promo_image_url}}" alt="" />
            <br />
            <h4>{{selectedPromo.promotion_name}}</h4>
            <p>
              <small>{{selectedPromo.summary}}</small>
            </p>
          </div>
        </div>
        <div class="row">
          <div class="twelve columns">
            <div class="centered">
              <h5>Drawing Schedule</h5>
            </div>
            <table class="schedule wide">
                <tr>
                  <th>Prize</th>
                  <th>Entry Deadline</th>
                  <th>Drawing Date</th>
                </tr>
                <tr ng-repeat="draw in selectedPromo.drawings">
                  <td>
                    {{draw.prize}}
                  </td>
                  <td>
                    {{draw.entry_deadline}}
                  </td>
                  <td>
                    {{draw.drawing_date | date:"fullDate"}}
                  </td>
                </tr>
            </table>


          </div>
        </div>
        <div class="row">
          <div class="twelve columns">
            <p>
              <small>{{selectedPromo.entry_info}}</small>
            </p>
          </div>
        </div>
        <div class="row">
          <div class="twelve columns">
            <div class="centered">
              <h5>Your Total Tickets Entered: {{selectedPromo.entries.length}}</h5>
              <p>
                All entries are locked at the time they are submitted and cannot be deleted.
              </p>
            </div>
            <table class="schedule wide">
                <tr>
                  <th>Entry Number</th>
                  <th>Date</th>
                </tr>
                <tr ng-repeat="entry in selectedPromo.entries">
                  <td>
                    {{entry.entry_number}}
                  </td>
                  <td>
                    {{entry.date | date:"fullDate"}}
                  </td>
                </tr>
            </table>
          </div>
        </div>
      </div>

    </div><!-- / container -->





    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.3/jquery.js"></script>
    <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/angularjs/1.3.14/angular.js"></script>
    <script type="text/javascript">

      var mock = angular.module('mockApp', []);

      // set the location provider to true for our location searches
      mock.config(function($locationProvider) {
        $locationProvider.html5Mode(true);
      });

      // listController function
      // uses angular $http $location and $scope modules to
      // retrieve and display webdevtest-data.js data
      var listController = function($http, $location, $scope) {


        var getData = $http.get('js/webdevtest-data.js');

        getData.success(function(data) {

          // our xhr data
          $scope.promoData = data;

          // our querystring as an object
          $scope.query = $location.search().promo;

          // function to serve as click handler in list view
          $scope.setQuery = function (id){
            $scope.query = id + 1; // plus one to match expected querystring
            // load the selected promo based on querystring
            $scope.loadPromo();
          }

          $scope.loadPromo = function() {
            // check if query is set
            if (typeof $scope.query !== 'undefined') {

              // get rid of text in query string
              var trimQuery = $scope.query.replace(/[^\d.]/g, '');

              // parse as integer and subtract one for zero indexed list
              trimQuery = parseInt(trimQuery,10) - 1;

              // select the promo by query from the promotion object list
              $scope.selectedPromo = $scope.promoData.promotion_objects[trimQuery];

            }
          }

          // run loadPromo in case query string was initial url
          $scope.loadPromo();

        });

        getData.error(function(err) {
          console.warn(err);
        });

      }

      // Pass listController to angular module
      mock.controller('listCtrl', ['$http', '$location', '$scope', listController]);



    </script>
  </body>
</html>
